# {{ ansible_managed }}
---
services:
  db:
    image: postgres:latest
    environment:
      - POSTGRES_DB=production
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD={{ a_backstage__db_password }}
    volumes:
      - db:/var/lib/postgresql/data
    networks:
      - default
    restart: always

  app:
    image: backstage:1.0.0
    labels:
      - traefik.docker.network=traefik
      - traefik.enable={{ a_backstage__routing_enabled }}
      - traefik.http.routers.backstage.entrypoints=websecure
      - traefik.http.routers.backstage.middlewares=sts-headers
      - traefik.http.routers.backstage.rule=Host(`{{ a_backstage__service_fqdn }}`)
      - traefik.http.routers.backstage.tls.certresolver=letsencrypt
      - traefik.http.routers.backstage.tls=true
      - traefik.http.services.backstage.loadbalancer.server.port=7007
    environment:
      - POSTGRES_DB=production
      - POSTGRES_HOST=db
      - POSTGRES_PASSWORD={{ a_backstage__db_password }}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=dbuser
    networks:
      - default
      - traefik
    restart: always

volumes:
  db:

networks:
  traefik:
    name: traefik
    external: true
